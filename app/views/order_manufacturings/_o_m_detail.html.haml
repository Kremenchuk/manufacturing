- @o_m_details.each_with_index do |item, item_counter|
  - if @o_m.present?
    - item_qty = @o_m.order_manufacturings_details.present? ? @o_m.order_manufacturings_details.find_by(item_id: item.id).qty : 0
  -else
    - item_qty = 0
  %tr
    %td{style: 'display: none'}
      = text_field_tag "details[id][]", item.id, id: "item_id_#{item_counter}", class: 'item_id_class'
    %td{style: 'display: none'}
      = text_field_tag "item_weight", item.weight.present? ? item.weight : 0, id: "item_weight_#{item_counter}", class: 'weight_class', 'data-counter': item_counter
    %td
      = item.name
    %td.unit-field{'data-counter': item_counter, id: "unit_#{item_counter}"}
      = item.unit
    %td
      = number_field_tag 'details[qty][]', item_qty, step: 0.01, class: 'form-control calculated_field', id: "qty_#{item_counter}", 'data-counter': item_counter
    %td{id: "remove_#{item_counter}", class: 'remove_row', 'data-counter': item_counter}



  -unless item_counter > 0
    :coffee
      # Вираховування загальної суми та ваги по item
      @sumWeight = (sum_field, unit_field, weight_field) ->
        i = 0
        result = 0
        percent = []
        weight_result = 0
        while i < sum_field.length
          id = $(sum_field[i]).data('counter')
          unit = $.trim($('#unit_' + id).text())
          if $('#qty_' + $(weight_field[i]).data('counter')).val()
            weight_result = weight_result + parseFloat($(weight_field[i]).val()) * parseFloat($('#qty_' + $(weight_field[i]).data('counter')).val())
          if unit != "%"
            result = result + parseFloat($(sum_field[i]).html())
          else
            percent.push({id: id, val: parseFloat($.trim($('#price_' + id).text()))})
          i++
        # Підрахунок процентних нарахувань з сумою по кожній позиції
        i = 0
        while i < percent.length
          $('#sum_' + percent[i]['id']).html(((result / 100.0) * percent[i]['val']).toFixed(2))
          result = result + (result / 100.0) * percent[i]['val']
          i++
        $('#item_weight').val(weight_result.toFixed(2))
        $('#item_price').val(result.toFixed(2))


      $ ->
        sum_field = document.getElementsByClassName('sum_field')
        unit_field = document.getElementsByClassName('unit-field')
        weight_field = document.getElementsByClassName('weight_class')
        sumWeight(sum_field, unit_field, weight_field)

        $('.calculated_field').on 'click', (e) ->
          $(this).select()

        $('.remove_row').on 'click', (e) ->
          id = $(this).data('counter')
          $(this).closest('tr').remove()

        # внесено зміни до поля кількості
        $('.calculated_field').on 'keyup', (e) ->
          re = /[а-яА-Яa-zA-Z]/
          if re.test($(this).val()) == false
            # Вираховування суми позиції в якій змінено кількість
            id = $(this).data('counter')
            qty = $('#qty_' + id).val()
            price = $('#price_' + id).html()
            $('#sum_' + id).html((qty * price).toFixed(2))

            sumWeight(sum_field, unit_field, weight_field)

            if e.keyCode == 13
              index = $(this).data('counter') + 1
              $("input.calculated_field[data-counter='" + index + "']").select()

